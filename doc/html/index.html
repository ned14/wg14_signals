<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>WG14 modern signals: Reference implementation for proposed extensions to standard C signals handling</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">WG14 modern signals
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Reference implementation for proposed extensions to standard C signals handling </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_Readme"></a> (C) 2024 - 2025 Niall Douglas <a href="http://www.nedproductions.biz/">http://www.nedproductions.biz/</a></p>
<p>CI: <a href="https://github.com/ned14/wg14_signals/actions/workflows/ci.yml"><img src="https://github.com/ned14/wg14_signals/actions/workflows/ci.yml/badge.svg" alt="CI" style="pointer-events: none;" class="inline"/></a></p>
<p>Can be configured to be a standard library implementation for your standard C library runtime. Licensed permissively.</p>
<h1><a class="anchor" id="autotoc_md2"></a>
Example of use</h1>
<div class="fragment"><div class="line"><span class="comment">/* Invoke `func` passing it `user_value`. If `SIGILL` is raised during the</span></div>
<div class="line"><span class="comment">execution of `func`, call `decider_func` as a filter to decide what to do.</span></div>
<div class="line"><span class="comment">If `decider_func` chooses to initiate recovery, perform as-if a `longjmp()`</span></div>
<div class="line"><span class="comment">back to before `func` was called, and invoke `recovery_func` to recover.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">`thrd_signal_invoke()` can be stacked i.e. `func` can invoke subfunctions</span></div>
<div class="line"><span class="comment">with their own signal raise filter functions.</span></div>
<div class="line"><span class="comment">*/</span></div>
<div class="line">sigset_t guarded;</div>
<div class="line">sigemptyset(&amp;guarded);</div>
<div class="line">sigaddset(&amp;guarded, SIGILL);</div>
<div class="line"><a class="code hl_function" href="thrd__signal__handle_8h.html#a7383ad2fc75d4ecc2243447bc6cd9318">thrd_signal_invoke</a>(&amp;guarded, func, recovery_func, decider_func, user_value);</div>
<div class="ttc" id="athrd__signal__handle_8h_html_a7383ad2fc75d4ecc2243447bc6cd9318"><div class="ttname"><a href="thrd__signal__handle_8h.html#a7383ad2fc75d4ecc2243447bc6cd9318">thrd_signal_invoke</a></div><div class="ttdeci">union thrd_raised_signal_info_value thrd_signal_invoke(const sigset_t *signals, thrd_signal_func_t guarded, thrd_signal_recover_t recovery, thrd_signal_decide_t decider, union thrd_raised_signal_info_value value)</div><div class="ttdoc">THREADSAFE USUALLY ASYNC-SIGNAL-SAFE Installs a thread-local signal guard for the calling thread,...</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md3"></a>
Supported targets</h1>
<p>This library should work well on any POSIX implementation, as well as Microsoft Windows. You will need a minimum of C 11 in your toolchain. Every architecture supporting C 11 atomics should work.</p>
<p>Current CI test targets:</p>
<ul>
<li>Ubuntu Linux, x64.</li>
<li>Mac OS, AArch64.</li>
<li>Microsoft Windows, x64.</li>
</ul>
<p>Current compilers:</p>
<ul>
<li>GCC</li>
<li>clang</li>
<li>MSVC</li>
</ul>
<h1><a class="anchor" id="autotoc_md4"></a>
Configuration</h1>
<p>You can find a number of user definable macros to override in <code><a class="el" href="config_8h.html">config.h</a></code>. They have sensible defaults on the major platforms and toolchains.</p>
<p>The only one to be especially aware of is <code>WG14_SIGNALS_HAVE_ASYNC_SAFE_THREAD_LOCAL</code>. If your platform and toolchain has async signal safe thread local storage, it can be used instead of a hash table which is much, much faster. Current platform status for this support can be read all about at <a href="https://maskray.me/blog/2021-02-14-all-about-thread-local-storage">https://maskray.me/blog/2021-02-14-all-about-thread-local-storage</a>, but to summarise:</p>
<ul>
<li>Most ELF platforms require the <code>initial-exec</code> TLS attribute, which we turn on for all GNU toolchains except on Apple ones. <b>IF</b> your libc reserves static TLS space for runtime loaded shared libraries (e.g. glibc), you can incorporate this library into runtime loaded shared libraries without issue. If it does not, runtime loading a shared library will fail. In this case, either place this library in a process bootstrap shared library or the program library, or force disable off use of async safe thread locals.</li>
<li>PE platforms (Microsoft Windows) use async thread safe thread locals in all situations. They are initialised when their shared library is loaded.</li>
<li>Mach O platforms (Apple) do not provide async thread safe thread locals and so the fallback hash table is always used on those platforms, which is unfortunate.</li>
</ul>
<h1><a class="anchor" id="autotoc_md5"></a>
Performance</h1>
<h2><a class="anchor" id="autotoc_md6"></a>
On my Threadripper 5975WX which is a 3.6Ghz processor bursting to 4.5Ghz on Linux:</h2>
<ul>
<li><code><a class="el" href="tss__async__signal__safe_8h.html#a8fd7beb001b06936be5994a39be21a9f" title="THREADSAFE ASYNC-SIGNAL-SAFE Get the thread local value for the current thread.">tss_async_signal_safe_get()</a></code> which implements an async signal safe thread local storage using a hash table costs about 8 nanoseconds, so maybe 29 clock cycles.</li>
</ul>
<p>With <code>WG14_SIGNALS_HAVE_ASYNC_SAFE_THREAD_LOCAL=1</code> (the default on Linux, Windows, and other ELF based platforms): </p><pre class="fragment">- `thrd_signal_invoke()` which invokes a function which thread locally
</pre><p> handles any signals raised costs about 16 nanoseconds (31 clock cycles) for the happy case (most of this is the cost of <code>_setjmp()</code> on this platform and glibc). </p><pre class="fragment">- A globally installed signal decider takes about 8 nanoseconds (29
</pre><p> clock cycles) to reach (there is a CAS lock-unlock sequence needed).</p>
<p>With <code>WG14_SIGNALS_HAVE_ASYNC_SAFE_THREAD_LOCAL=0</code>: </p><pre class="fragment">- `thrd_signal_invoke()` which invokes a function which thread locally
</pre><p> handles any signals raised costs about 25 nanoseconds for the happy case. </p><pre class="fragment">- A globally installed signal decider takes about 10 nanoseconds to reach.
</pre> <h2><a class="anchor" id="autotoc_md7"></a>
On a MacBook Pro M3 running ARM64</h2>
<ul>
<li><code><a class="el" href="tss__async__signal__safe_8h.html#a8fd7beb001b06936be5994a39be21a9f" title="THREADSAFE ASYNC-SIGNAL-SAFE Get the thread local value for the current thread.">tss_async_signal_safe_get()</a></code> which implements an async signal safe thread local storage using a hash table costs about 16 nanoseconds.<ul>
<li><code><a class="el" href="thrd__signal__handle_8h.html#a7383ad2fc75d4ecc2243447bc6cd9318" title="THREADSAFE USUALLY ASYNC-SIGNAL-SAFE Installs a thread-local signal guard for the calling thread,...">thrd_signal_invoke()</a></code> which invokes a function which thread locally handles any signals raised costs about 20 nanoseconds for the happy case (most of this is the cost of <code>_setjmp()</code> on this platform and libc).</li>
<li>A globally installed signal decider takes about 20 nanoseconds to reach (there is a CAS lock-unlock sequence needed, and a hash table lookup).</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md8"></a>
On a MacBook Pro M3 running ARM64 Windows within a VM</h2>
<ul>
<li><code><a class="el" href="tss__async__signal__safe_8h.html#a8fd7beb001b06936be5994a39be21a9f" title="THREADSAFE ASYNC-SIGNAL-SAFE Get the thread local value for the current thread.">tss_async_signal_safe_get()</a></code> which implements an async signal safe thread local storage using a hash table costs about 22 nanoseconds.</li>
<li><code><a class="el" href="thrd__signal__handle_8h.html#a7383ad2fc75d4ecc2243447bc6cd9318" title="THREADSAFE USUALLY ASYNC-SIGNAL-SAFE Installs a thread-local signal guard for the calling thread,...">thrd_signal_invoke()</a></code> which invokes a function which thread locally handles any signals raised costs about 17 nanoseconds (this is Windows Structured Exception Handling, not our library code).</li>
<li>A globally installed signal decider takes about 7,372 nanoseconds to reach (this is also Windows code, not our library code, shame it is so slow).</li>
</ul>
<h1><a class="anchor" id="autotoc_md9"></a>
Todo</h1>
<ul>
<li>Global signal deciders are still racy with respect to modification during invocation. Given that they execute in an async signal unsafe situation, not sure how much I care. </li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
